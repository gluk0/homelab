---
- name: Fetch Kubeconfig from Control Plane
  hosts: k8s_control_planes[0]
  become: yes
  become_user: ansible
  gather_facts: yes

  tasks:
    - name: Check if kubeconfig exists
      stat:
        path: /home/ansible/.kube/config
      register: kubeconfig_stat

    - name: Fail if kubeconfig doesn't exist
      fail:
        msg: "Kubeconfig not found at /home/ansible/.kube/config on {{ inventory_hostname }}"
      when: not kubeconfig_stat.stat.exists

    - name: Fetch kubeconfig from control plane
      fetch:
        src: /home/ansible/.kube/config
        dest: /tmp/homelab-kubeconfig
        flat: yes

    - name: Display success message
      debug:
        msg:
          - "==========================================="
          - "Kubeconfig fetched successfully!"
          - "==========================================="
          - "Source: {{ inventory_hostname }}:/home/ansible/.kube/config"
          - "Destination: /tmp/homelab-kubeconfig"
