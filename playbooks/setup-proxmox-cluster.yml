---
- name: Create Proxmox Cluster Master
  hosts: pve-01
  become: yes
  gather_facts: yes

  vars:
    cluster_name: homelab-cluster

  tasks:
    - name: Check if node is already in a cluster
      shell: pvecm status 2>/dev/null || echo "No cluster"
      register: cluster_check
      changed_when: false
      failed_when: false

    - name: Display cluster status
      debug:
        msg: "{{ cluster_check.stdout }}"

    - name: Create cluster on master node
      shell: pvecm create {{ cluster_name }}
      when: "'No cluster' in cluster_check.stdout"
      register: cluster_created
      failed_when:
        - cluster_created.rc != 0
        - "'already part of a cluster' not in cluster_created.stderr"

    - name: Wait for cluster to be ready
      wait_for:
        timeout: 10
      when: cluster_created.changed

    - name: Verify cluster created
      shell: pvecm status
      register: cluster_status
      changed_when: false

    - name: Display cluster status
      debug:
        msg: "{{ cluster_status.stdout_lines }}"

- name: Add Remaining Nodes to Cluster
  hosts: proxmox:!pve-01
  become: yes
  gather_facts: yes

  vars:
    cluster_master_ip: "{{ hostvars['pve-01']['ansible_host'] }}"

  tasks:
    - name: Check if node is already in a cluster
      shell: pvecm status 2>/dev/null || echo "No cluster"
      register: cluster_check
      changed_when: false
      failed_when: false

    - name: Add node to cluster
      shell: pvecm add {{ cluster_master_ip }} --use_ssh --force
      when: "'No cluster' in cluster_check.stdout"
      register: node_added
      failed_when:
        - node_added.rc != 0
        - "'already part of a cluster' not in node_added.stderr"

    - name: Wait for node to join
      wait_for:
        timeout: 10
      when: node_added.changed

    - name: Verify node joined cluster
      shell: pvecm status
      register: node_status
      changed_when: false
      failed_when: false

    - name: Display node cluster status
      debug:
        msg: "{{ node_status.stdout_lines }}"

- name: Verify Complete Cluster
  hosts: pve-01
  become: yes
  gather_facts: yes

  tasks:
    - name: Get final cluster nodes list
      shell: pvecm nodes
      register: cluster_nodes
      changed_when: false

    - name: Display complete cluster
      debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

    - name: Get cluster status
      shell: pvecm status
      register: final_status
      changed_when: false

    - name: Display final cluster status
      debug:
        msg: "{{ final_status.stdout_lines }}"
