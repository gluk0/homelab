---
- name: Prepare Proxmox Nodes for Clustering
  hosts: proxmox
  become: yes
  gather_facts: yes

  tasks:
    - name: Ensure all cluster nodes are in /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item]['ansible_host'] }} {{ item }}.homelab.local {{ item }}"
        regexp: "^{{ hostvars[item]['ansible_host'] }}.*{{ item }}"
        state: present
      loop:
        - pve-01
        - pve-02
        - pve-03
      when: item != inventory_hostname

    - name: Generate SSH key on each node
      shell: test -f /root/.ssh/id_rsa || ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa
      register: ssh_keygen
      changed_when: "'already exists' not in ssh_keygen.stderr"

    - name: Fetch public key from each node
      slurp:
        src: /root/.ssh/id_rsa.pub
      register: ssh_pubkey

    - name: Distribute SSH keys to all nodes
      authorized_key:
        user: root
        key: "{{ hostvars[item]['ssh_pubkey']['content'] | b64decode }}"
        state: present
      loop: "{{ groups['proxmox'] }}"
      when: item != inventory_hostname

- name: Create Proxmox Cluster Master
  hosts: pve-01
  become: yes
  gather_facts: yes

  vars:
    cluster_name: homelab-cluster

  tasks:
    - name: Check if node is already in a cluster
      shell: pvecm status 2>/dev/null || echo "No cluster"
      register: cluster_check
      changed_when: false
      failed_when: false

    - name: Create cluster on master node
      shell: pvecm create {{ cluster_name }}
      when: "'No cluster' in cluster_check.stdout"
      register: cluster_created
      failed_when:
        - cluster_created.rc != 0
        - "'already part of a cluster' not in cluster_created.stderr"

    - name: Wait for cluster to be ready
      wait_for:
        timeout: 15
      when: cluster_created.changed

- name: Add Remaining Nodes to Cluster
  hosts: proxmox:!pve-01
  become: yes
  gather_facts: yes
  serial: 1

  tasks:
    - name: Check if node is already in a cluster
      shell: pvecm status 2>/dev/null || echo "No cluster"
      register: cluster_check
      changed_when: false
      failed_when: false

    - name: Add node to cluster
      shell: pvecm add pve-01 --use_ssh --force
      when: "'No cluster' in cluster_check.stdout"
      register: node_added
      failed_when:
        - node_added.rc != 0
        - "'already part of a cluster' not in node_added.stderr"

    - name: Wait for node to join
      wait_for:
        timeout: 15
      when: node_added.changed

- name: Verify Complete Cluster
  hosts: pve-01
  become: yes
  gather_facts: yes

  tasks:
    - name: Wait for cluster to sync
      wait_for:
        timeout: 10

    - name: Get final cluster nodes list
      shell: pvecm nodes
      register: cluster_nodes
      changed_when: false

    - name: Display complete cluster
      debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

    - name: Get cluster status
      shell: pvecm status
      register: final_status
      changed_when: false

    - name: Display final cluster status
      debug:
        msg: "{{ final_status.stdout_lines }}"
