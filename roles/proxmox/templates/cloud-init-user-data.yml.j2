#cloud-config
# Cloud-init configuration for Kubernetes-ready VMs
# Generated by Ansible

hostname: k8s-node
manage_etc_hosts: true
fqdn: k8s-node.{{ homelab_domain }}

users:
  - name: {{ cloudinit_user }}
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
{% for key in cloudinit_ssh_keys %}
      - {{ key }}
{% endfor %}

package_update: true
package_upgrade: true

packages:
{% for package in cloudinit_packages %}
  - {{ package }}
{% endfor %}
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - containerd

runcmd:
  # Disable swap
  - swapoff -a
  - sed -i '/ swap / s/^/#/' /etc/fstab

  # Configure kernel modules
  - modprobe overlay
  - modprobe br_netfilter

  # Configure sysctl
  - sysctl --system

  # Configure containerd
  - mkdir -p /etc/containerd
  - containerd config default > /etc/containerd/config.toml
  - sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
  - systemctl restart containerd
  - systemctl enable containerd

  # Enable qemu-guest-agent
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent

  # Set timezone
  - timedatectl set-timezone {{ homelab_timezone }}

  # Configure DNS
  - echo "DNS={{ dns_primary }}" >> /etc/systemd/resolved.conf
  - echo "FallbackDNS={{ dns_secondary }}" >> /etc/systemd/resolved.conf
  - systemctl restart systemd-resolved

write_files:
  - path: /etc/modules-load.d/k8s.conf
    content: |
{% for module in k8s_load_modules %}
      {{ module }}
{% endfor %}
    permissions: '0644'

  - path: /etc/sysctl.d/k8s.conf
    content: |
{% for key, value in k8s_sysctl_params.items() %}
      {{ key }} = {{ value }}
{% endfor %}
    permissions: '0644'

  - path: /etc/crictl.yaml
    content: |
      runtime-endpoint: unix:///run/containerd/containerd.sock
      image-endpoint: unix:///run/containerd/containerd.sock
      timeout: 10
    permissions: '0644'

timezone: {{ homelab_timezone }}

final_message: "Cloud-init complete. System is ready for Kubernetes deployment."
